name: $(majorVersion).$(minorVersion).$(Rev:r)

trigger:
- master

pool:
  vmImage: windows-latest

variables:
  buildConfiguration: Release
  pathToSolutionFile: CacheMeIfYouCan.sln
  pathToMainTestProject: tests/CacheMeIfYouCan.Tests/CacheMeIfYouCan.Tests.csproj
  pathToCronTestProject: tests/CacheMeIfYouCan.Cron.Tests/CacheMeIfYouCan.Cron.Tests.csproj
  pathToPollyTestProject: tests/CacheMeIfYouCan.Polly.Tests/CacheMeIfYouCan.Polly.Tests.csproj
  pathToRedisTestProject: tests/CacheMeIfYouCan.Redis.Tests/CacheMeIfYouCan.Redis.Tests.csproj
  
steps:
- task: DotNetCoreCLI@2
  displayName: Build
  inputs:
    command: build
    projects: $(pathToSolutionFile)
    configurationToPack: $(buildConfiguration)

- task: DotNetCoreCLI@2
  displayName: Test CacheMeIfYouCan
  inputs:
    command: test
    projects: $(pathToMainTestProject)
    configuration: $(buildConfiguration)
    nobuild: true

- task: DotNetCoreCLI@2
  displayName: Test CacheMeIfYouCan.Cron
  inputs:
    command: test
    projects: $(pathToCronTestProject)
    configuration: $(buildConfiguration)
    nobuild: true

- task: DotNetCoreCLI@2
  displayName: Test CacheMeIfYouCan.Polly
  inputs:
    command: test
    project: $(pathToPollyTestProject)
    configuration: $(buildConfiguration)
    nobuild: true

- task: DotNetCoreCLI@2
  displayName: Test CacheMeIfYouCan.Redis
  inputs:
    command: test
    project: $(pathToRedisTestProject)
    configuration: $(buildConfiguration)
    nobuild: true

- task: DotNetCoreCLI@2
  displayName: Pack
  inputs:
    command: pack
    packagesToPack: 'src/**/*.csproj'
    versioningScheme: byBuildNumber
    configuration: $(buildConfiguration)
    nobuild: true

- task: NuGetCommand@2
  displayName: Publish Packages
  inputs:
    command: push
    packagesToPush: '$(Build.ArtifactStagingDirectory)/**/*.nupkg;!$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg'
    feedsToUse: select
    nuGetFeedType: internal
    publishVstsFeed: Default